<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habits Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>

<!-- Loader -->
<div id="appLoader" class="loader-overlay">
    <div class="spinner"></div>
</div>

<!-- Sync Status -->
<div id="syncStatus" class="sync-status">
    <div id="syncDot" class="sync-dot"></div><span id="syncText">Saved</span>
</div>

<!-- Mobile FAB -->
<button id="mobileFab" onclick="openModal('habit')">
    <i class="ph ph-plus"></i>
</button>

<div class="app-container">
    <header>
        <div class="brand">
            <h1>Habits</h1>
            <p id="dateDisplay">Loading...</p>
        </div>

        <div class="controls">
            <select id="viewSelector" class="view-select" onchange="switchView()">
                <option value="me">My Habits</option>
            </select>

            <button class="btn-icon" onclick="openModal('friends')" title="Friends">
                <i class="ph ph-users"></i>
            </button>
            
            <!-- Study Room -->
            <button class="btn-icon" onclick="openModal('study')" title="Study Room">
                <i class="ph ph-clock"></i>
            </button>
            
            <button class="btn-icon" onclick="openModal('settings')" title="Settings">
                <i class="ph ph-gear"></i>
            </button>

            <div style="width: 1px; height: 20px; background: var(--border); margin: 0 5px;"></div>

            <button class="btn-icon" onclick="changeMonth(-1)"><i class="ph ph-caret-left"></i></button>
            <button class="btn-icon" onclick="changeMonth(1)"><i class="ph ph-caret-right"></i></button>
            
            <button class="btn-icon" onclick="toggleTheme()">
                <i class="ph ph-sun" id="themeIcon"></i>
            </button>
            
            <button class="btn-icon" onclick="logout()" style="color: var(--error);">
                <i class="ph ph-sign-out"></i>
            </button>
        </div>
    </header>

    <div class="table-wrapper">
        <table>
            <thead><tr id="headerRow"></tr></thead>
            <tbody id="habitBody"></tbody>
            <tfoot><tr id="footerRow" class="footer-row"></tr></tfoot>
        </table>
        <div id="emptyState" class="empty-state" style="display:none;">
            <i class="ph ph-check-square-offset"></i>
            <p>No habits yet. Add one to start your streak!</p>
        </div>
    </div>

    <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
        <button id="desktopAddBtn" class="btn-primary" onclick="openModal('habit')">
            <i class="ph ph-plus-circle" style="font-size: 1.2rem;"></i> Add Habit
        </button>
    </div>
</div>

<!-- MODAL SYSTEM -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h2 id="modalTitle" style="margin:0;">Title</h2>
            <button onclick="closeModal()" class="btn-icon" style="width:30px; height:30px; font-size:1rem;"><i class="ph ph-x"></i></button>
        </div>
        
        <div id="modalBody"></div>
        
        <div id="modalFooter" style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="btn-primary" id="modalActionBtn">Save</button>
        </div>
    </div>
</div>

<script>
    const db = getDB();
    let currentUser, viewingUserId, canEdit = true;
    let dateCursor = new Date();
    let currentListTitle = "HABITS";
    let myUsername = "";
    
    // Realtime
    let roomChannel, myStudyStart = null, onlineUsers = {};

    window.onload = async () => {
        try {
            // 1. Init Theme
            const theme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('themeIcon').classList.replace(theme === 'dark' ? 'ph-moon' : 'ph-sun', theme === 'dark' ? 'ph-sun' : 'ph-moon');

            // 2. Check Auth
            const { data: { session } } = await db.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            
            currentUser = session.user;
            viewingUserId = currentUser.id;

            // 3. Init Study Time
            const savedStart = localStorage.getItem('studyStartTime');
            if (savedStart) myStudyStart = parseInt(savedStart);

            // 4. Critical Loads
            await checkUsername();
            await loadFriends();
            await render();
            initRealtime();

        } catch (err) {
            console.error("Init Error:", err);
            alert("Something went wrong loading data. Please refresh.");
        } finally {
            // 5. SAFETY NET: Always hide loader
            document.getElementById('appLoader').style.opacity = '0';
            setTimeout(() => document.getElementById('appLoader').style.display = 'none', 500);
        }
    };

    // --- REALTIME ---
    function initRealtime() {
        roomChannel = supabase.channel('habits_global')
            .on('presence', { event: 'sync' }, () => {
                const newState = roomChannel.presenceState();
                onlineUsers = {};
                for (const id in newState) onlineUsers[id] = newState[id][0];
                updateOnlineUI();
            })
            .subscribe(async (status) => {
                if (status === 'SUBSCRIBED') await sendPresence();
            });
        setInterval(updateStudyVisuals, 1000);
    }

    async function sendPresence() {
        if (!myUsername) return;
        await roomChannel.track({ user_id: currentUser.id, username: myUsername, is_studying: !!myStudyStart, started_at: myStudyStart });
    }

    function updateOnlineUI() {
        document.querySelectorAll('.status-dot-user').forEach(el => {
            const uid = el.dataset.uid;
            if (onlineUsers[uid]) el.className = `status-dot-user ${onlineUsers[uid].is_studying ? 'studying' : 'online'}`;
            else el.className = 'status-dot-user';
        });
        
        const container = document.getElementById('activeStudyingList');
        if (container) {
            let html = '';
            for (const key in onlineUsers) {
                const u = onlineUsers[key];
                if (u.is_studying && u.user_id !== currentUser.id) {
                    html += `<div class="studying-card"><div class="status-dot-user studying"></div><div><span>${u.username}</span><br><span class="studying-time" data-start="${u.started_at}">...</span></div></div>`;
                }
            }
            container.innerHTML = html || '<p style="color:var(--text-sub); font-size:0.9rem;">No friends studying.</p>';
        }
    }

    function updateStudyVisuals() {
        if (myStudyStart) document.getElementById('mainTimer').innerText = formatTime(Math.floor((Date.now() - myStudyStart) / 1000));
        document.querySelectorAll('.studying-time').forEach(el => {
            const start = parseInt(el.dataset.start);
            if(start) el.innerText = formatTime(Math.floor((Date.now() - start)/1000));
        });
    }

    // --- CORE LOGIC ---
    async function checkUsername() {
        // Check profile exists, if not create temp one (Fallback fix)
        let { data, error } = await db.from('profiles').select('username').eq('id', currentUser.id).maybeSingle();
        
        if (!data) {
            // Force create profile if missing
            const tempName = 'user_' + Math.floor(Math.random() * 10000);
            await db.from('profiles').insert({ id: currentUser.id, email: currentUser.email, username: tempName });
            data = { username: tempName };
        }

        myUsername = data.username;
        if(myUsername.startsWith('user_')) { 
            openModal('setup_username');
            document.querySelector('.modal-overlay').style.pointerEvents = 'auto'; 
            document.querySelector('.modal-overlay button.btn-icon').style.display = 'none'; 
        }
    }

    let usernameDebounce;
    async function validateUsername(val) {
        const statusIcon = document.getElementById('uStatus');
        const btn = document.getElementById('modalActionBtn');
        if(val.length < 3) { statusIcon.className = ''; btn.disabled = true; return; }
        clearTimeout(usernameDebounce);
        statusIcon.className = 'ph ph-spinner ph-spin'; 
        usernameDebounce = setTimeout(async () => {
            const { data } = await db.from('profiles').select('id').eq('username', val).maybeSingle();
            if(data && data.id !== currentUser.id) { statusIcon.className = 'ph ph-x-circle status-bad'; btn.disabled = true; } 
            else { statusIcon.className = 'ph ph-check-circle status-ok'; btn.disabled = false; }
        }, 500);
    }

    async function render() {
        setSync('saving');
        const year = dateCursor.getFullYear();
        const month = dateCursor.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        document.getElementById('dateDisplay').innerText = dateCursor.toLocaleString('default', { month: 'long', year: 'numeric' });

        const { data: profile } = await db.from('profiles').select('list_title').eq('id', viewingUserId).single();
        currentListTitle = profile ? profile.list_title : "HABITS";

        const { data: habits } = await db.from('habits').select('*').eq('user_id', viewingUserId).order('created_at');
        
        let logs = [];
        if (habits && habits.length > 0) {
            const ids = habits.map(h => h.id);
            const start = `${year}-${String(month+1).padStart(2,'0')}-01`;
            const end = `${year}-${String(month+1).padStart(2,'0')}-${daysInMonth}`;
            const { data } = await db.from('habit_logs').select('*').in('habit_id', ids).gte('log_date', start).lte('log_date', end);
            logs = data || [];
        }

        const hasHabits = habits && habits.length > 0;
        document.getElementById('emptyState').style.display = hasHabits ? 'none' : 'block';
        document.getElementById('habitBody').style.display = hasHabits ? 'table-row-group' : 'none';

        renderHeader(daysInMonth, year, month);
        if(hasHabits) renderBody(habits, logs, daysInMonth, year, month);
        renderFooter(daysInMonth, year, month, habits, logs);
        setSync('saved');
    }

    function renderHeader(days, year, month) {
        const isMe = viewingUserId === currentUser.id;
        const clickAttr = isMe ? `onclick="openModal('rename_list')"` : '';
        const editIcon = isMe ? `<i class="ph ph-pencil-simple" style="font-size:0.8rem; margin-left:5px; opacity:0.5;"></i>` : '';
        
        let html = `<th style="cursor:pointer;" ${clickAttr}>${currentListTitle}${editIcon}</th>`;
        const today = new Date();
        
        for(let i=1; i<=days; i++) {
            const d = new Date(year, month, i);
            const isToday = d.toDateString() === today.toDateString();
            const bgStyle = isToday ? 'background: var(--highlight); color: var(--primary);' : '';
            const dayName = d.toLocaleDateString('en-US', {weekday:'narrow'});
            html += `<th style="${bgStyle}"><div>${i}</div><div style="font-size:0.6rem; font-weight:400;">${dayName}</div></th>`;
        }
        document.getElementById('headerRow').innerHTML = html;
    }

    function renderBody(habits, logs, days, year, month) {
        const tbody = document.getElementById('habitBody');
        tbody.innerHTML = '';
        const isMe = viewingUserId === currentUser.id;

        habits.forEach(h => {
            let row = `<tr class="habit-row">
                <td class="habit-name">
                    <span onclick="${isMe ? `openModal('rename_habit', ${h.id}, '${h.title}')` : ''}">${h.title}</span>
                    ${isMe ? `<div class="habit-actions"><i class="ph ph-trash action-icon" onclick="deleteHabit(${h.id})"></i></div>` : ''}
                </td>`;
            
            for(let i=1; i<=days; i++) {
                const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const checked = logs.some(l => l.habit_id === h.id && l.log_date === dStr && l.completed);
                const disabled = (!isMe && !canEdit) ? 'disabled' : '';
                row += `<td><input type="checkbox" ${checked ? 'checked' : ''} ${disabled} onchange="toggle(${h.id}, '${dStr}', this.checked)"></td>`;
            }
            tbody.innerHTML += row + '</tr>';
        });
    }

    function renderFooter(days, year, month, habits, logs) {
        let html = '<td><div style="padding-left:25px;">Daily %</div></td>';
        for(let i=1; i<=days; i++) {
            const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            let total = habits.length;
            let done = (total > 0) ? logs.filter(l => habits.some(h=>h.id===l.habit_id) && l.log_date===dStr).length : 0;
            let p = total===0 ? 0 : Math.round((done/total)*100);
            html += `<td><div class="circle-stat" style="--p: ${p}%"><span>${p}%</span></div></td>`;
        }
        document.getElementById('footerRow').innerHTML = html;
    }

    // --- ACTIONS ---
    function setSync(status) {
        const box = document.getElementById('syncStatus');
        const dot = document.getElementById('syncDot');
        const txt = document.getElementById('syncText');
        box.classList.add('visible');
        dot.className = 'sync-dot ' + status;
        if(status === 'saving') txt.innerText = "Syncing...";
        else if (status === 'saved') { txt.innerText = "Saved"; setTimeout(() => box.classList.remove('visible'), 2000); }
        else txt.innerText = "Error";
    }

    async function toggle(hid, date, val) {
        setSync('saving');
        if(val) await db.from('habit_logs').insert({ habit_id: hid, log_date: date });
        else await db.from('habit_logs').delete().match({ habit_id: hid, log_date: date });
        render(); setSync('saved');
    }

    async function deleteHabit(id) {
        if(confirm("Delete habit?")) { setSync('saving'); await db.from('habits').delete().eq('id', id); render(); setSync('saved'); }
    }

    function changeMonth(d) { dateCursor.setMonth(dateCursor.getMonth() + d); render(); }
    
    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        document.getElementById('themeIcon').classList.replace(next==='dark'?'ph-sun':'ph-moon', next==='dark'?'ph-sun':'ph-moon');
    }
    
    async function logout() { await db.auth.signOut(); window.location.href = 'index.html'; }

    // --- FRIENDS & MODALS ---
    let modalState = {}; 

    async function loadFriends() {
        const { data } = await db.from('profile_access').select('owner_id, can_edit, profiles:owner_id(username)').eq('viewer_id', currentUser.id);
        const s = document.getElementById('viewSelector');
        s.innerHTML = '<option value="me">My Habits</option>';
        if(data) data.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.owner_id; opt.dataset.edit = r.can_edit; opt.innerText = r.profiles.username + "'s Habits";
            s.appendChild(opt);
        });
    }

    function switchView() {
        const s = document.getElementById('viewSelector');
        const dBtn = document.getElementById('desktopAddBtn');
        const mBtn = document.getElementById('mobileFab');
        if(s.value === 'me') { 
            viewingUserId = currentUser.id; canEdit = true; 
            if(dBtn) dBtn.style.display = 'flex'; if(mBtn) mBtn.style.display = 'flex';
        } else { 
            viewingUserId = s.value; canEdit = (s.options[s.selectedIndex].dataset.edit === 'true'); 
            if(dBtn) dBtn.style.display = 'none'; if(mBtn) mBtn.style.display = 'none';
        }
        render();
    }

    async function openModal(type, id=null, txt='') {
        modalState = { type, id };
        const overlay = document.getElementById('modalOverlay');
        const title = document.getElementById('modalTitle');
        const body = document.getElementById('modalBody');
        const btn = document.getElementById('modalActionBtn');
        
        overlay.classList.add('open');
        btn.style.display = 'block'; btn.disabled = false; btn.innerText = "Save";

        if (type === 'study') {
            title.innerText = "Study Room";
            btn.style.display = 'none'; 
            const { data: logs } = await db.from('study_logs').select('duration_minutes').eq('user_id', currentUser.id);
            const totalHrs = (logs ? logs.reduce((sum, r) => sum + r.duration_minutes, 0) : 0) / 60;
            const isStudying = !!myStudyStart;
            
            body.innerHTML = `
                <div class="study-container">
                    <div class="total-time-badge">Total Focus: ${totalHrs.toFixed(1)} hrs</div>
                    <div id="mainTimer" class="timer-display">${isStudying ? "00:00:00" : "00:00:00"}</div>
                    <button id="studyToggleBtn" class="study-btn ${isStudying ? 'active' : ''}" onclick="toggleStudy()">
                        <i class="ph-fill ${isStudying ? 'ph-stop-circle' : 'ph-play-circle'}"></i>
                        ${isStudying ? "Stop Session" : "Start Session"}
                    </button>
                    <div id="activeStudyingList" class="studying-users"></div>
                </div>`;
            updateStudyVisuals(); updateOnlineUI();
        }
        else if(type === 'habit') {
            title.innerText = "Add Habit";
            body.innerHTML = `<input type="text" id="mInput" class="input-field" placeholder="e.g. Drink Water">`;
            setTimeout(() => document.getElementById('mInput').focus(), 100);
        }
        else if (type === 'rename_habit') {
            title.innerText = "Rename Habit";
            body.innerHTML = `<input type="text" id="mInput" class="input-field" value="${txt}">`;
        }
        else if (type === 'setup_username' || type === 'settings') {
            title.innerText = type === 'setup_username' ? "Welcome! Pick a Username" : "Settings";
            body.innerHTML = `
                <p style="font-size:0.85rem; color:var(--text-sub); margin-bottom:10px;">Unique username for friends to find you.</p>
                <div class="input-group">
                    <input type="text" id="mInput" class="input-field" value="${myUsername.startsWith('user_')?'':myUsername}" onkeyup="validateUsername(this.value)">
                    <i id="uStatus" class="input-status"></i>
                </div>`;
            btn.disabled = true; 
        }
        else if (type === 'friends') {
            title.innerText = "Friends";
            btn.style.display = 'none'; 
            renderFriendManager(body);
        }
        else if (type === 'rename_list') {
            title.innerText = "List Name";
            body.innerHTML = `<input type="text" id="mInput" class="input-field" value="${currentListTitle}">`;
        }
    }

    async function renderFriendManager(container) {
        const { data } = await db.from('profile_access').select('id, viewer_id, can_edit, profiles:viewer_id(id, username)').eq('owner_id', currentUser.id);
        let html = `
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="friendInput" class="input-field" placeholder="Enter Username">
                <button class="btn-primary" onclick="addFriend()">Add</button>
            </div>
            <div style="max-height:200px; overflow-y:auto; border-top:1px solid var(--border); padding-top:10px;">`;
        
        if(!data || data.length === 0) html += `<p style="text-align:center; color:var(--text-sub);">No friends added yet.</p>`;
        else {
            data.forEach(f => {
                const uid = f.profiles.id;
                const isOnline = onlineUsers[uid];
                const dotClass = isOnline ? (isOnline.is_studying ? 'studying' : 'online') : '';
                html += `
                <div class="friend-list-item">
                    <div style="display:flex; align-items:center;">
                        <div class="status-dot-user ${dotClass}" data-uid="${uid}"></div>
                        <span class="friend-info">${f.profiles.username}</span>
                    </div>
                    <div class="friend-actions">
                        <button style="font-size:0.7rem; border:1px solid var(--border); background:${f.can_edit?'var(--success)':'var(--bg-surface)'}; color:${f.can_edit?'white':'var(--text-sub)'}; border-radius:4px;" 
                        onclick="togglePerm(${f.id}, ${!f.can_edit})">${f.can_edit?'Editor':'Viewer'}</button>
                        <button style="color:var(--error);" onclick="removeFriend(${f.id})"><i class="ph ph-trash"></i></button>
                    </div>
                </div>`;
            });
        }
        container.innerHTML = html + `</div>`;
    }

    async function addFriend() {
        const val = document.getElementById('friendInput').value;
        const { data } = await db.from('profiles').select('id').eq('username', val).single();
        if(!data) return alert("User not found!");
        await db.from('profile_access').insert({ owner_id: currentUser.id, viewer_id: data.id });
        renderFriendManager(document.getElementById('modalBody'));
    }
    async function togglePerm(id, val) { await db.from('profile_access').update({ can_edit: val }).eq('id', id); renderFriendManager(document.getElementById('modalBody')); }
    async function removeFriend(id) { await db.from('profile_access').delete().eq('id', id); renderFriendManager(document.getElementById('modalBody')); }

    // --- STUDY LOGIC ---
    async function toggleStudy() {
        const btn = document.getElementById('studyToggleBtn');
        if (!myStudyStart) {
            myStudyStart = Date.now(); localStorage.setItem('studyStartTime', myStudyStart);
            btn.innerText = "Stop Session"; btn.classList.add('active');
        } else {
            const dur = Math.ceil((Date.now() - myStudyStart) / 1000 / 60);
            await db.from('study_logs').insert({ user_id: currentUser.id, started_at: new Date(myStudyStart).toISOString(), duration_minutes: dur });
            myStudyStart = null; localStorage.removeItem('studyStartTime');
            btn.classList.remove('active'); btn.innerText = "Start Session"; document.getElementById('mainTimer').innerText = "00:00:00";
        }
        await sendPresence();
    }
    function formatTime(s) { return new Date(s * 1000).toISOString().substr(11, 8); }

    function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }

    document.getElementById('modalActionBtn').onclick = async () => {
        const val = document.getElementById('mInput').value;
        if(!val) return;
        setSync('saving');
        if(modalState.type === 'habit') await db.from('habits').insert({ user_id: currentUser.id, title: val });
        else if (modalState.type === 'rename_habit') await db.from('habits').update({ title: val }).eq('id', modalState.id);
        else if (modalState.type === 'rename_list') await db.from('profiles').update({ list_title: val }).eq('id', currentUser.id);
        else if (modalState.type === 'setup_username' || modalState.type === 'settings') {
            const { error } = await db.from('profiles').update({ username: val }).eq('id', currentUser.id);
            if(!error) { 
                myUsername = val; 
                window.location.reload(); 
                return; 
            }
        }
        setSync('saved'); closeModal(); render();
    };
</script>
</body>
</html>