<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habits</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>

<div class="app-container">
    <header>
        <div class="title-group">
            <h1>Habits</h1>
            <p id="currentDateText" class="subtitle">Loading...</p>
        </div>

        <div class="controls">
            <!-- Friend Switcher -->
            <select id="viewSelector" class="view-select" onchange="switchProfileView()">
                <option value="me">My Habits</option>
            </select>

            <!-- Manage Friends Btn -->
            <button class="btn-secondary btn-icon" onclick="openModal('friend')" title="Add Friend">
                ðŸ‘¥
            </button>

            <!-- Date Nav -->
            <button class="btn-secondary" onclick="changeMonth(-1)">â€¹</button>
            <button class="btn-secondary" onclick="changeMonth(1)">â€º</button>

            <!-- Logout -->
            <button class="btn-secondary" onclick="logout()">Log Out</button>
        </div>
    </header>

    <div class="table-wrapper">
        <table id="trackerTable">
            <thead><tr id="headerRow"></tr></thead>
            <tbody id="habitBody"></tbody>
            <tfoot><tr id="footerRow" class="footer-row"></tr></tfoot>
        </table>
    </div>

    <!-- Add Habit Button (Only visible on own profile) -->
    <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
        <button id="addHabitBtn" class="btn-primary" onclick="openModal('habit')">+ Add Habit</button>
    </div>
</div>

<!-- === MODAL === -->
<div class="modal-overlay" id="mainModal">
    <div class="modal">
        <h2 id="modalTitle">Title</h2>
        <p id="modalDesc" style="color:#666; font-size:0.9rem; margin-bottom:10px;"></p>
        
        <input type="text" id="modalInput" class="input-field" placeholder="...">
        
        <div id="friendOptions" style="display:none; margin-bottom:15px;">
            <label style="display:flex; align-items:center; gap:10px; font-size:0.9rem;">
                <input type="checkbox" id="canEditCheck"> Allow them to edit my habits?
            </label>
        </div>

        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn-primary" id="modalConfirmBtn">Confirm</button>
        </div>
    </div>
</div>

<script>
    const db = getDB();
    let currentUser = null;
    let viewingUserId = null;
    let canEditCurrentView = true;
    let currentDate = new Date();

    window.onload = async () => {
        const { data: { session } } = await db.auth.getSession();
        if (!session) { window.location.href = 'index.html'; return; }
        
        currentUser = session.user;
        viewingUserId = currentUser.id;

        await loadFriendsList(); 
        renderView();
    };

    async function logout() {
        await db.auth.signOut();
        window.location.href = 'index.html';
    }

    // --- RENDER ---
    async function renderView() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        document.getElementById('currentDateText').innerText = 
            currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });

        renderHeader(daysInMonth, year, month);

        // Fetch Habits
        const { data: habits } = await db.from('habits').select('*').eq('user_id', viewingUserId).order('created_at');
        
        // Fetch Logs for this month
        const startStr = `${year}-${String(month+1).padStart(2,'0')}-01`;
        const endStr = `${year}-${String(month+1).padStart(2,'0')}-${daysInMonth}`;
        
        const { data: logs } = await db.from('habit_logs').select('*')
            .gte('log_date', startStr).lte('log_date', endStr);

        renderBody(habits || [], logs || [], daysInMonth, year, month);
    }

    function renderHeader(daysInMonth, year, month) {
        const tr = document.getElementById('headerRow');
        let html = '<th>HABIT</th>';
        const today = new Date();

        for(let i=1; i<=daysInMonth; i++) {
            const date = new Date(year, month, i);
            const dayName = date.toLocaleDateString('en-US', {weekday:'narrow'});
            const isToday = (date.toDateString() === today.toDateString()) ? 'background: #fff0f5; color: var(--primary-dark);' : '';
            
            html += `<th style="${isToday}">
                <div>${i}</div><div style="font-weight:400; opacity:0.6; font-size:0.7rem;">${dayName}</div>
            </th>`;
        }
        tr.innerHTML = html;
    }

    function renderBody(habits, logs, daysInMonth, year, month) {
        const tbody = document.getElementById('habitBody');
        const tfoot = document.getElementById('footerRow');
        tbody.innerHTML = '';
        
        const isMe = viewingUserId === currentUser.id;

        habits.forEach(habit => {
            let rowHtml = `<td>
                <div class="habit-name-wrapper">
                    <span class="habit-text" onclick="${isMe ? `openModal('rename', ${habit.id}, '${habit.title}')` : ''}">
                        ${habit.title}
                    </span>
                    ${isMe ? `<button class="mini-btn" onclick="deleteHabit(${habit.id})">Ã—</button>` : ''}
                </div>
            </td>`;

            for(let i=1; i<=daysInMonth; i++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const isChecked = logs.some(l => l.habit_id === habit.id && l.log_date === dateStr && l.completed);
                const disabled = (!isMe && !canEditCurrentView) ? 'disabled' : '';

                rowHtml += `<td>
                    <input type="checkbox" ${isChecked ? 'checked' : ''} ${disabled} 
                    onchange="toggleCheck(${habit.id}, '${dateStr}', this.checked)">
                </td>`;
            }
            tbody.innerHTML += `<tr>${rowHtml}</tr>`;
        });

        // Stats Footer
        let footerHtml = '<td>Daily Progress</td>';
        for(let i=1; i<=daysInMonth; i++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            let total = habits.length;
            let completed = 0;
            if(total > 0) {
                completed = logs.filter(l => habits.some(h => h.id === l.habit_id) && l.log_date === dateStr).length;
            }
            let percent = total === 0 ? 0 : Math.round((completed / total) * 100);

            footerHtml += `<td>
                <div class="circle-chart" style="--p: ${percent}%">
                    <span class="circle-text">${percent}%</span>
                </div>
            </td>`;
        }
        tfoot.innerHTML = `<tr>${footerHtml}</tr>`;
    }

    // --- ACTIONS ---
    async function toggleCheck(habitId, dateStr, checked) {
        if(checked) await db.from('habit_logs').insert({ habit_id: habitId, log_date: dateStr, completed: true });
        else await db.from('habit_logs').delete().match({ habit_id: habitId, log_date: dateStr });
        renderView();
    }

    async function deleteHabit(id) {
        if(confirm("Delete habit?")) {
            await db.from('habits').delete().eq('id', id);
            renderView();
        }
    }

    async function loadFriendsList() {
        const { data } = await db.from('profile_access')
            .select(`owner_id, can_edit, profiles:owner_id (email)`)
            .eq('viewer_id', currentUser.id);
        
        const select = document.getElementById('viewSelector');
        select.innerHTML = '<option value="me">My Habits</option>'; 

        if(data) {
            data.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.owner_id;
                opt.dataset.edit = item.can_edit;
                opt.innerText = item.profiles.email.split('@')[0] + "'s Habits";
                select.appendChild(opt);
            });
        }
    }

    function switchProfileView() {
        const select = document.getElementById('viewSelector');
        if(select.value === 'me') {
            viewingUserId = currentUser.id;
            canEditCurrentView = true;
            document.getElementById('addHabitBtn').style.display = 'block';
        } else {
            viewingUserId = select.value;
            canEditCurrentView = select.options[select.selectedIndex].dataset.edit === 'true';
            document.getElementById('addHabitBtn').style.display = 'none';
        }
        renderView();
    }

    function changeMonth(dir) {
        currentDate.setMonth(currentDate.getMonth() + dir);
        renderView();
    }

    // --- MODAL SYSTEM ---
    let currentModalType = '';
    let currentHabitId = null;

    function openModal(type, id=null, existingText='') {
        const overlay = document.getElementById('mainModal');
        const title = document.getElementById('modalTitle');
        const desc = document.getElementById('modalDesc');
        const input = document.getElementById('modalInput');
        const friendOpts = document.getElementById('friendOptions');
        
        currentModalType = type;
        currentHabitId = id;
        input.value = existingText;
        friendOpts.style.display = 'none';
        overlay.classList.add('active');

        if(type === 'habit') {
            title.innerText = "New Habit";
            desc.innerText = "What do you want to track?";
            input.placeholder = "e.g. Read 10 mins";
        } else if (type === 'rename') {
            title.innerText = "Rename Habit";
            desc.innerText = "Update name:";
        } else if (type === 'friend') {
            title.innerText = "Add Friend";
            desc.innerText = "Enter friend's email to grant access.";
            input.placeholder = "friend@email.com";
            friendOpts.style.display = 'block';
        }
        input.focus();
    }

    function closeModal() { document.getElementById('mainModal').classList.remove('active'); }

    document.getElementById('modalConfirmBtn').onclick = async () => {
        const val = document.getElementById('modalInput').value;
        if(!val) return;
        closeModal();

        if(currentModalType === 'habit') {
            await db.from('habits').insert({ user_id: currentUser.id, title: val });
            renderView();
        } 
        else if (currentModalType === 'rename') {
            await db.from('habits').update({ title: val }).eq('id', currentHabitId);
            renderView();
        }
        else if (currentModalType === 'friend') {
            const { data: user } = await db.from('profiles').select('id').eq('email', val).single();
            if(!user) return alert("User not found! They must sign up first.");
            
            const canEdit = document.getElementById('canEditCheck').checked;
            const { error } = await db.from('profile_access').insert({
                owner_id: currentUser.id, viewer_id: user.id, can_edit: canEdit
            });
            if(error) alert("Error: " + error.message);
            else alert(`Friend added!`);
        }
    };
</script>
</body>
</html>