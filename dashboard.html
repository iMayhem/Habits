<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>

<div class="app-wrapper">
    <header>
        <div class="header-left">
            <h1>Zenith <span>Tracker</span></h1>
        </div>
        
        <div class="header-controls">
            <!-- View Selector (My Profile vs Friends) -->
            <select id="viewSelector" class="view-selector" onchange="switchProfileView()">
                <option value="me">My Habits</option>
                <!-- Friend options added dynamically -->
            </select>

            <!-- Date Nav -->
            <div class="date-nav">
                <button class="nav-btn" onclick="changeMonth(-1)">&#8249;</button>
                <span id="currentViewDisplay">Loading...</span>
                <button class="nav-btn" onclick="changeMonth(1)">&#8250;</button>
            </div>

            <!-- Action Buttons -->
            <button class="nav-btn" onclick="grantAccess()" title="Give Access to Friend">ðŸ‘¥</button>
            <button class="nav-btn" onclick="logout()" title="Log Out">ðŸšª</button>

            <!-- Theme -->
            <div class="theme-toggle" onclick="toggleTheme()">
                <div class="toggle-circle"></div>
            </div>
        </div>
    </header>

    <div class="table-container">
        <div class="scroll-area">
            <table id="trackerTable">
                <thead><tr id="headerRow"></tr></thead>
                <tbody id="habitBody"></tbody>
            </table>
        </div>
        <!-- Only show Add button if viewing OWN profile -->
        <button id="addHabitBtn" class="fab" onclick="addHabit()">+</button>
    </div>
</div>

<script>
    const db = getDB();
    let currentUser = null;
    let viewingUserId = null; // Whose habits are we looking at?
    let currentDate = new Date();
    let canEditCurrentView = true; // Do we have permission to check boxes?

    // --- INIT ---
    window.onload = async () => {
        // Theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Auth Check
        const { data: { session }, error } = await db.auth.getSession();
        if (error || !session) { window.location.href = 'index.html'; return; }
        
        currentUser = session.user;
        viewingUserId = currentUser.id; // Start by viewing self

        await loadFriendsList();
        renderView();
    };

    async function logout() {
        await db.auth.signOut();
        window.location.href = 'index.html';
    }

    // --- VIEW LOGIC ---

    async function loadFriendsList() {
        // Get list of people who shared their profile with me
        const { data: accessList, error } = await db
            .from('profile_access')
            .select(`owner_id, can_edit, profiles:owner_id (email)`)
            .eq('viewer_id', currentUser.id);

        const selector = document.getElementById('viewSelector');
        
        if(accessList) {
            accessList.forEach(access => {
                const option = document.createElement('option');
                option.value = access.owner_id;
                // Store edit permission in a data attribute
                option.dataset.canEdit = access.can_edit; 
                option.innerText = access.profiles.email.split('@')[0] + "'s Habits";
                selector.appendChild(option);
            });
        }
    }

    function switchProfileView() {
        const selector = document.getElementById('viewSelector');
        viewingUserId = selector.value;
        
        if (viewingUserId === 'me') {
            viewingUserId = currentUser.id;
            canEditCurrentView = true;
            document.getElementById('addHabitBtn').style.display = 'flex';
        } else {
            // Check if selected option allows editing
            const selectedOption = selector.options[selector.selectedIndex];
            canEditCurrentView = (selectedOption.dataset.canEdit === 'true');
            document.getElementById('addHabitBtn').style.display = 'none';
        }
        
        renderView();
    }

    // --- DATA LOADING & RENDER ---

    async function renderView() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // 1. Header Title
        document.getElementById('currentViewDisplay').innerText = 
            currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });

        // 2. Render Table Header
        renderHeader(year, month);

        // 3. Load Habits & Logs
        const { data: habits } = await db
            .from('habits')
            .select('*')
            .eq('user_id', viewingUserId)
            .order('created_at', { ascending: true });

        const startOfMonth = new Date(year, month, 1).toISOString();
        const endOfMonth = new Date(year, month + 1, 0).toISOString();

        const { data: logs } = await db
            .from('habit_logs')
            .select('*')
            .gte('log_date', startOfMonth)
            .lte('log_date', endOfMonth);

        renderBody(habits || [], logs || [], year, month);
    }

    function renderHeader(year, month) {
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
        
        let html = '<th>HABIT</th>';
        for(let i=1; i<=daysInMonth; i++) {
            const d = new Date(year, month, i);
            const dayName = d.toLocaleDateString('en-US', {weekday:'narrow'});
            const isToday = isCurrentMonth && i === today.getDate() ? 'today-col' : '';
            
            html += `<th class="${isToday}">
                <div style="font-size:1.1em; color:var(--text-main)">${i}</div>
                <div style="opacity:0.6; font-size:0.8em">${dayName}</div>
            </th>`;
        }
        document.getElementById('headerRow').innerHTML = html;
    }

    function renderBody(habits, logs, year, month) {
        const tbody = document.getElementById('habitBody');
        tbody.innerHTML = '';
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const isMyProfile = viewingUserId === currentUser.id;

        if(habits.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${daysInMonth+1}" style="padding:30px; color:var(--text-muted);">No habits found for this profile.</td></tr>`;
            return;
        }

        habits.forEach(habit => {
            let rowHTML = `<td>
                <div class="habit-label">
                    ${habit.title}
                    ${isMyProfile ? `<span class="delete-icon" onclick="deleteHabit(${habit.id})">&times;</span>` : ''}
                </div>
            </td>`;

            for(let i=1; i<=daysInMonth; i++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                // Check if this habit is logged for this date
                const isChecked = logs.some(l => l.habit_id === habit.id && l.log_date === dateStr);
                const checkedAttr = isChecked ? 'checked' : '';
                
                // Determine if checkbox is clickable
                const isDisabled = !canEditCurrentView ? 'disabled' : '';
                const today = new Date();
                const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
                const isTodayClass = isCurrentMonth && i === today.getDate() ? 'today-col' : '';

                rowHTML += `<td class="${isTodayClass}">
                    <div class="check-container">
                        <input type="checkbox" ${checkedAttr} ${isDisabled} 
                               onchange="toggleCheck(${habit.id}, '${dateStr}', this.checked)">
                    </div>
                </td>`;
            }
            const tr = document.createElement('tr');
            tr.innerHTML = rowHTML;
            tbody.appendChild(tr);
        });
    }

    // --- ACTIONS ---

    async function addHabit() {
        const title = prompt("New Habit Name:");
        if(!title) return;
        const { error } = await db.from('habits').insert({ user_id: currentUser.id, title: title });
        if(error) alert(error.message);
        else renderView();
    }

    async function deleteHabit(id) {
        if(confirm("Delete this habit?")) {
            await db.from('habits').delete().eq('id', id);
            renderView();
        }
    }

    async function toggleCheck(habitId, dateStr, isChecked) {
        if(isChecked) {
            await db.from('habit_logs').insert({ habit_id: habitId, log_date: dateStr, completed: true });
        } else {
            await db.from('habit_logs').delete().match({ habit_id: habitId, log_date: dateStr });
        }
    }

    async function grantAccess() {
        const email = prompt("Enter friend's email to grant access to YOUR habits:");
        if(!email) return;

        // 1. Get friend ID
        const { data: friend, error } = await db.from('profiles').select('id').eq('email', email).single();
        if(error || !friend) { alert("User not found!"); return; }

        // 2. Ask permission level
        const type = prompt("Type 'edit' to let them check boxes, or anything else for View Only:");
        const canEdit = (type && type.toLowerCase() === 'edit');

        // 3. Insert Permission
        const { error: permError } = await db.from('profile_access').insert({
            owner_id: currentUser.id,
            viewer_id: friend.id,
            can_edit: canEdit
        });

        if(permError) alert("Error: " + permError.message);
        else alert(`Access granted to ${email} (${canEdit ? 'Edit' : 'View Only'})`);
    }

    // --- UTILS ---
    function changeMonth(dir) {
        currentDate.setMonth(currentDate.getMonth() + dir);
        renderView();
    }

    function toggleTheme() {
        const html = document.documentElement;
        const next = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        html.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    }
</script>
</body>
</html>