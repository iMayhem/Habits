<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Habits</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>

<div class="app-container">
    <header>
        <div class="brand-logo" style="font-size:1.8rem; margin:0;">Habits.</div>
        
        <div class="header-actions">
            <div class="user-profile">
                <div class="avatar" id="userAvatar">U</div>
                <div class="username" id="userEmail">Loading...</div>
            </div>
            <button class="action-btn" onclick="shareHabit()">
                <span>Share</span> â†—
            </button>
            <button class="action-btn" onclick="logout()" style="color:var(--danger); border-color: rgba(255, 118, 117, 0.3);">
                Log Out
            </button>
        </div>
    </header>

    <div class="table-wrapper">
        <div class="scroll-box">
            <table id="trackerTable">
                <thead><tr id="headerRow"></tr></thead>
                <tbody id="habitBody"></tbody>
            </table>
        </div>
    </div>
    
    <button class="fab-btn" onclick="addHabit()">+</button>
</div>

<script>
    const db = getDB();
    let currentUser = null;
    let currentDate = new Date();

    window.onload = async () => {
        // 1. Check Login Status
        const { data: { session }, error } = await db.auth.getSession();
        if (error || !session) {
            window.location.href = 'index.html';
            return;
        }
        
        currentUser = session.user;
        
        // Update UI with User Info
        const name = currentUser.email ? currentUser.email.split('@')[0] : "User";
        document.getElementById('userEmail').innerText = name;
        document.getElementById('userAvatar').innerText = name.charAt(0).toUpperCase();
        
        renderHeader();
        loadHabits();
    };

    async function logout() {
        await db.auth.signOut();
        window.location.href = 'index.html';
    }

    // --- CORE FUNCTIONS ---

    async function loadHabits() {
        // Fetch Habits
        const { data: habits, error } = await db
            .from('habits')
            .select(`*, habit_permissions(shared_with_user_id, can_edit)`)
            .order('created_at', { ascending: true });

        if (error) {
            console.error("Error loading habits:", error);
            return;
        }

        // Fetch Logs (Checkmarks) for current month
        const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
        const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).toISOString();

        const { data: logs, error: logError } = await db
            .from('habit_logs')
            .select('*')
            .gte('log_date', startOfMonth)
            .lte('log_date', endOfMonth);

        if (logError) console.error("Error loading logs:", logError);

        renderBody(habits || [], logs || []);
    }

    async function addHabit() {
        const title = prompt("âœ¨ What habit do you want to build?");
        if(!title) return;

        // Insert with error handling
        const { data, error } = await db
            .from('habits')
            .insert({ user_id: currentUser.id, title: title })
            .select();

        if (error) {
            alert("Error creating habit: " + error.message + "\n\nTip: Check the SQL Console fix.");
            console.error(error);
        } else {
            loadHabits(); // Refresh list
        }
    }

    async function toggleCheck(habitId, dateStr, isChecked) {
        if(isChecked) {
            const { error } = await db.from('habit_logs').insert({ habit_id: habitId, log_date: dateStr, completed: true });
            if(error) console.error("Check failed", error);
        } else {
            const { error } = await db.from('habit_logs').delete().match({ habit_id: habitId, log_date: dateStr });
            if(error) console.error("Uncheck failed", error);
        }
    }

    async function deleteHabit(id) {
        if(confirm("Are you sure you want to delete this habit?")) {
            const { error } = await db.from('habits').delete().eq('id', id);
            if(error) alert("Could not delete: " + error.message);
            else loadHabits();
        }
    }

    async function shareHabit() {
        const email = prompt("ðŸ“§ Enter friend's email to share with:");
        if(!email) return;

        // 1. Find the friend's ID
        const { data: users, error } = await db.from('profiles').select('id').eq('email', email).single();
        
        if(error || !users) { 
            alert("User not found! Ask them to sign up/log in once so their profile is created."); 
            return; 
        }

        // 2. Pick habit
        const habitName = prompt("Which habit name to share?");
        const { data: habit } = await db.from('habits').select('id').eq('title', habitName).eq('user_id', currentUser.id).single();
        
        if(!habit) { alert("Habit not found (or you don't own it)."); return; }

        // 3. Share
        const { error: shareError } = await db.from('habit_permissions').insert({
            habit_id: habit.id, shared_with_user_id: users.id, can_edit: true
        });

        if(shareError) alert("Could not share: " + shareError.message);
        else alert(`Successfully shared '${habitName}'!`);
    }

    // --- RENDER HELPERS ---

    function renderHeader() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        let html = '<th>HABIT NAME</th>';
        for(let i=1; i<=daysInMonth; i++) {
            const d = new Date(year, month, i);
            const dayName = d.toLocaleDateString('en-US', {weekday:'narrow'});
            const isToday = (i === new Date().getDate() && month === new Date().getMonth()) ? 'color:var(--primary); font-weight:800;' : '';
            html += `<th style="${isToday} text-align:center;">${i}<br><span style="font-weight:400; opacity:0.6;">${dayName}</span></th>`;
        }
        document.getElementById('headerRow').innerHTML = html;
    }

    function renderBody(habits, logs) {
        const tbody = document.getElementById('habitBody');
        tbody.innerHTML = '';
        const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();

        if(habits.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${daysInMonth+1}" style="padding:40px; text-align:center; color:var(--text-muted);">âœ¨ Start by adding a new habit below.</td></tr>`;
            return;
        }

        habits.forEach(habit => {
            const isShared = habit.user_id !== currentUser.id;
            const sharedBadge = isShared ? `<span class="tag-shared">From Friend</span>` : '';
            
            let html = `<td>
                <div class="habit-title">
                    <span>${habit.title} ${sharedBadge}</span>
                    ${!isShared ? `<button class="icon-btn delete-btn" onclick="deleteHabit(${habit.id})">ðŸ—‘</button>` : ''}
                </div>
            </td>`;

            for(let i=1; i<=daysInMonth; i++) {
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const log = logs.find(l => l.habit_id === habit.id && l.log_date === dateStr);
                const checked = log ? 'checked' : '';

                html += `<td><div class="check-wrap">
                    <input type="checkbox" ${checked} onchange="toggleCheck(${habit.id}, '${dateStr}', this.checked)">
                </div></td>`;
            }
            const tr = document.createElement('tr');
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });
    }
</script>
</body>
</html>